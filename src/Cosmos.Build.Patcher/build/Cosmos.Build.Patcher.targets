<Project>

  <PropertyGroup>
    <!--
      Windows only: if not overridden, assume the global Cosmos.Patcher
      tool is installed at %USERPROFILE%\.dotnet\tools\cosmos.patcher.exe
    -->
    <CosmosPatcherExe Condition="'$(OS)'=='Windows_NT' and '$(CosmosPatcherExe)' == ''">$(USERPROFILE)\.dotnet\tools\cosmos.patcher.exe</CosmosPatcherExe>
  </PropertyGroup>

  <PropertyGroup>
    <PatchedAssembly />
    <EnablePatching Condition="'$(EnablePatching)'!='false'">true</EnablePatching>
    <EnableAOT>true</EnableAOT>
  </PropertyGroup>

  <UsingTask TaskName="Cosmos.Patcher.Build.Tasks.PatcherTask"
             AssemblyFile="$(CosmosPatcherTasksAssembly)" />

  <Target Name="Log" BeforeTargets="BeforeBuild">
    <Message Importance="High" Text="MSBuildThisFileDirectory: '$(MSBuildThisFileDirectory)'" />
    <Message Importance="High" Text="Configuration: '$(Configuration)'" />
    <Message Importance="High" Text="OutputPath: '$(OutputPath)'" />
    <Message Importance="High" Text="IntermediateOutputPath: '$(IntermediateOutputPath)'" />
    <Message Importance="High" Text="PatcherBuildDll: '$(PatcherBuildDll)'" />
    <Message Importance="High" Text="PatcherPath: '$(PatcherPath)'" />
    <Message Importance="High" Text="PatcherOutputPath: '$(PatcherOutputPath)'" />
    <Message Importance="High" Text="PatchedAssembly: '$(PatchedAssembly)'" />
    <Message Importance="High" Text="TargetFramework: '$(TargetFramework)'" />
    <Message Importance="High" Text="PatcherExists: Exists('$(PatcherPath)')" />
    <Message Importance="High" Text="PatcherTask:$(PatcherTask)" />
  </Target>

  <Target Name="SetupPatcher" AfterTargets="Build">
    <PropertyGroup>
      <PatcherOutputPath Condition="$(PatcherOutputPath) == ''">$(IntermediateOutputPath)/cosmos/ref/</PatcherOutputPath>
      <!-- The Main Assembly is patched to the root folder of Cosmos to make it easy to be found by other build tools -->
      <PatchedAssembly Condition="$(PatcherOutputPath) == ''">$(IntermediateOutputPath)/cosmos/$(AssemblyName)_patched.dll</PatchedAssembly>
    </PropertyGroup>

    <ItemGroup>
      <AssembliesToPatch Include="$(OutputPath)$(AssemblyName).dll">
        <PatcherOutputPath>$(IntermediateOutputPath)/cosmos/$(AssemblyName)_patched.dll</PatcherOutputPath>
      </AssembliesToPatch>
      <AssembliesToPatch Include="@(ReferencePath)">
        <PatcherOutputPath>$(IntermediateOutputPath)/cosmos/ref/%(Filename).dll</PatcherOutputPath>
      </AssembliesToPatch>
      <AssembliesToPatch Include="@(PrivateSdkAssemblies)">
        <PatcherOutputPath>$(IntermediateOutputPath)/cosmos/ref/%(Filename).dll</PatcherOutputPath>
      </AssembliesToPatch>
      <AssembliesToPatch Include="@(FrameworkAssemblies)">
        <PatcherOutputPath>$(IntermediateOutputPath)/cosmos/ref/%(Filename).dll</PatcherOutputPath>
      </AssembliesToPatch>
    </ItemGroup>
    
    <!-- Filter references to find plug assemblies based on PlugReference assembly names -->
    <ItemGroup>
      <!-- Always include the main assembly as a plug -->
      <PlugRef Include="$(OutputPath)$(AssemblyName).dll" />
      
      <!-- Filter ReferencePath items that match PlugReference assembly names -->
      <PlugRef Include="@(ReferencePath)" 
               Condition="'%(ReferencePath.Filename)' != '' and '@(PlugReference)' != '' and $([System.String]::new('@(PlugReference, ';')').Contains('%(ReferencePath.Filename)'))" />
      
      <!-- Also check for references in the output directory that match PlugReference names -->
      <PlugRef Include="$(OutputPath)%(PlugReference.Identity).dll" 
               Condition="Exists('$(OutputPath)%(PlugReference.Identity).dll')" />
    </ItemGroup>

    <!-- Remove duplicates from PlugRef -->
    <RemoveDuplicates Inputs="@(PlugRef)">
      <Output TaskParameter="Filtered" ItemName="UniquePlugRef"/>
    </RemoveDuplicates>
    
    <ItemGroup>
      <PlugRef Remove="@(PlugRef)" />
      <PlugRef Include="@(UniquePlugRef)" />
    </ItemGroup>
    
    <!-- Clean Output Path -->
    <RemoveDir Directories="$(PatcherOutputPath)" />

    <!-- Ensure the output directory exists -->
    <MakeDir Directories="$(PatcherOutputPath)" />

    <Message Importance="High" Text="PlugReference Assembly Names:" />
    <Message Importance="High" Text="  %(PlugReference.Identity)" />
    
    <Message Importance="High" Text="Resolved PlugRef DLL Paths:" />
    <Message Importance="High" Text="  %(PlugRef.Identity)" />
  </Target>
  
  <!-- Clean target to remove the asm folder -->
  <Target Name="CleanPatcher" BeforeTargets="Clean">
    <PropertyGroup>
      <PatcherOutputPath>$(IntermediateOutputPath)/cosmos/asm/</PatcherOutputPath>
    </PropertyGroup>

    <RemoveDir Directories="$(PatcherOutputPath)" />
  </Target>

  <Import Project="Patcher.Build.Unix.targets" Condition="'$(OS)' != 'Windows_NT'"/>
  <Import Project="Patcher.Build.Windows.targets" Condition="'$(OS)' == 'Windows_NT'"/>

</Project>
